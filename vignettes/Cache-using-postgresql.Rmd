---
title: "Using alternate database backends for Cache"
author:
  - "Alex M. Chubaty"
  - "Eliot J. B. McIntire"
date: '`r strftime(Sys.Date(), "%B %d %Y")`'
output:
  rmarkdown::html_vignette:
    fig_width: 7
    number_sections: yes
    self_contained: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{Using alternate database backends for Cache}
  %\VignetteDepends{DBI, RPostgres}
  %\VignetteKeyword{Cache, postgresql}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(#cache = TRUE,
                      message = FALSE, warning = FALSE,
                      echo = TRUE, eval = FALSE)
```

# Cache database backends

By default, caching relies on a sqlite database for it's backend.
While this works in many situations, there are some important limitations of using sqlite for caching, including 1) speed; 2) concurrent transactions; 3) sharing database across machines or projects.
Fortunately, `Cache` makes use of `DBI` package and thus supports several database backends, including mysql and postgresql.
This vignette demonstrates how to use alternate database backends for caching.

# Storing database credentials

**Be careful not to save database credentials in version control.**
We recommend per-project credentials saved either in config files or environment variables, described below.

See <https://solutions.rstudio.com/db/best-practices/managing-credentials/> for other important best practices.

# PostgreSQL

## Using environment variables

Add the following to your project's `.Renviron` file:

```{bash}
PGHOST="localhost"
PGPORT=5432
PGDATABASE="mydatabase"
PGUSER="mydbuser"
PGPASSWORD="mysecurepassword"
```

Then, in your main project script, add the following:

```{r}
readRenviron(".Renviron") ## alternatively, use global ~/.Renviron

conn <-   DBI::dbConnect(drv = RPostgres::Postgres(),
                         host = Sys.getenv("PGHOST"),
                         port = Sys.getenv("PGPORT"),
                         dbname = Sys.getenv("PGDATABASE"),
                         user = Sys.getenv("PGUSER"),
                         password = Sys.getenv("PGPASSWORD"))

options("reproducible.conn" = conn) # sets the default connection globally
```

**NOTE:** database connections are not serializable, which means that they cannot be passed to e.g., spawned child processes if running in parallel.
A new database connection will need to be established in each of the child processes using the `DBI::dbConnect()` call and setting the `reproducible.conn` option per above.
